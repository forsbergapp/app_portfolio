# Development

## Oracle Cloud
Create an account and start creating an infrastructure in the cloud.
`https://www.oracle.com/cloud/`

## VSCodium
    
VSCodium for building applications.

Configuration path:
`$HOME$/app_portfolio/.vscode/launch.json`

Debugging configurations:

App Portfolio
Microservice Batch              all batch jobs have enabled = false by default, enable provided CI/CD jobs on CI/CD server, not in development environment, 
                                add custom development batch job as needed


## Git

### Basic useful git commands

```
//clone remote repository
git clone [repository .git url]

//config, updates .git/CONFIG
git config user.email "[email]"
git config user.name "[name]”
git remote set-url origin https://[TOKEN]@[git host]/[USERNAME]/[REPOSITORY].git

//basic commands
git add *
git restore [path to file]
git commit -m "comment"
git push

//changes in latest commit
git commit --amend
git config pull.rebase true
git push -f

//git history commands:
git show [commit]
git show --name-only [commit]
git show --name-only --pretty=format: [commit] 
git show --name-status[commit]
git log --patch
git log --raw
git whatchanged
git for-each-ref --sort=creatordate --format '[%(refname:short)] %(creatordate:short) %(objectname)' refs/tags

//search return max 10 results in JSON format
git --no-pager log --all --grep="[search]" -n 10 --skip=1 --pretty=format:"{%n 'commit': '%H',%n 'author':'%aN <%aE>',%n 'date':'%ad',%n 'message':'%s'%n},"

//change author and email in commits and tags (BACKUP!):
git config user.name "[new name]"
git config user.email "[new email]"
git filter-branch --env-filter \
			'export GIT_AUTHOR_NAME="[name]" 
			 export GIT_AUTHOR_EMAIL="[email]"
			 export GIT_COMMITTER_NAME="[name]"
			 export GIT_COMITTER_EMAIL="[email]"' --tag-name-filter cat -- --all
git reflog expire --expire=now --all
git gc --prune=now
//delete remote old tags
git tag -l |xargs git push --delete origin
//push changes
git push --force origin --tags

```

example:
.git/CONFIG:

```
[core]
	repositoryformatversion = 0
	filemode = false
	bare = false
	logallrefupdates = true
	symlinks = false
	ignorecase = false
[remote "origin"]
	url = [https://<YOUR_TOKEN>@ [git host]/<YOUR_USERNAME>/<YOUR_REPOSITORY>.git]
	fetch = +refs/heads/*:refs/remotes/origin/*
[branch "main"]
	remote = origin
	merge = refs/heads/main
[user]
	email = [email]
	name  = [name]
```

### Git Release management

> **Note:** The commands here are only for localhost

Project uses release tags and environment tags using annotated git tags only that points to commits so the tag can be connected to project code saved in the commit message.

Release tags use git tag messages for release information.
Environment tags and descriptions are optional to use if a certain server need to act as TEST or PRODUCTION.
If not using environment tags then CI/CD application servers will be default latest version from git repository.

Release info keywords:
- Added: New features or functionality.
- Changed: Modifications or updates to existing features.
- Fixed: Bug fixes and other improvements.
- Deprecated: Features that are being phased out.
- Removed: Features that have been completely removed.
- Security: Updates related to security fixes.

How to recreate a tag with date from an old commit date (set env variables for each tag with the commit)
Observe that the first position in the description can not be '#'
```
export COMMIT=$(git rev-parse [commit])
export COMMIT_DATE=$(git show -s --format=%cd --date=iso8601-strict $COMMIT)
export GIT_AUTHOR_DATE="$COMMIT_DATE"
export GIT_COMMITTER_DATE="$COMMIT_DATE"
git tag -d [tag]
//Release tag
git tag -a [version tag] $COMMIT  -m '\n### [keyword]\n- Description'
//Environment tag
git tag -a [TEST/PRODUCTION etc] $COMMIT -m '' --force
```
How to update a message in older commit than the latest. Backup any tag message if necessary
```
git rebase -i HEAD~[number of commits]
//change 'pick' to 'reword' for desired commit, save, edit commit message, save
//update any tag and follow instructions for release tag and environment tags
git push --force origin --tags
```
How to set a tag on a specific commit (remove all env variables to use current date) and use changelog pattern and markdown.
This is probably the most used for setting release tags and environment tags.
```
//Release tag
git tag -a [version tag] [commit] -m '\n### Added\n- Description\n### Changed\n- Description\n### Fixed\n- Description\n### Removed\n- Description\n### Security\n- Description'
//Environment tag
git tag -a [TEST/PRODUCTION etc] [commit] -m '' --force
```
#### Distribute tags

> **Note:** The commands here are only for localhost

How to sync added, renamed and deleted tags, the remote tags must be deleted first
```
//delete all remote tags first, git command lists by default repeated tags with ^{}, use grep or sed and awk commands and use unique sort
//dry run with echo first
git ls-remote --tags |grep -v '\^{\}&dollar;' |awk -F/ '{print $3}'|sort -u| xargs -r -n1 echo git push --delete origin
//or
git ls-remote --tags | awk '{print &dollar;2}'|sed 's|refs/tags/||'|sed 's|\^{}||'|sort -u| xargs -r -n1 echo git push --delete origin
//review result then delete the remote tags
git ls-remote --tags |grep -v '\^{\}&dollar;' |awk -F/ '{print $3}'|sort -u| xargs -r -n1 git push --delete origin
//or
git ls-remote --tags | awk '{print &dollar;2}'|sed 's|refs/tags/||'|sed 's|\^{}||'|sort -u| xargs -r -n1 git push --delete origin
//push new and changed tags to remote server
git push --force origin --tags
```

How to sync tags that are added or updated only
```
//delete first remote tags if desired
git tag -l |xargs git push --delete origin
git push --force origin --tags
```

#### CI/CD on the application server
> **Note:** The commands here are only for the application server

The CI/CD solution is to use git in localhost and git and batch on the application server. 

Git does not sync deleted tags so it is important to execute git commands in correct order.
Command to fetch to given tag and fetch all tags, reset to fetched tag, delete tags newer than last commit and to delete local tags not on remote server
```
//replace $ENVIRONMENT with TEST, PROD or any tag
git fetch origin $ENVIRONMENT --tags --force && git reset --hard FETCH_HEAD && git tag -l |xargs -I T bash -c 'if [[ $(git log -1 "T" --format=%ci) > $(git log -1 --format=%ci) ]]; then echo git tag -d  "T"; fi' && git tag | grep -vxFf <(git ls-remote --tags origin| awk '{print $2}'|sed 's|refs/tags/||')|xargs git tag -d
```

#### To create change log report 

Each tag lists with descriptions starting with \n###

```
//sort descending: '--sort=-creatordate', ascending: --sort=creatordate
git for-each-ref --sort=-creatordate --format '## [%(refname:short)] - %(creatordate:short) %(contents)' refs/tags
//Result:
## [Tag] - Date
### [Keyword]
- Description
...
## [Tag] - Date
### [Keyword]
- Description
...
```

## Typescript

VSCodium have inbuilt support for Typescript and type check is implemented using 
JSDoc comment syntax so no Typescript compiler is needed or any other typescript npm module.

Open a Javascript file to review if any Typescript issue. Use typescript module with Typescript
compiler if scanning of multiple files is needed but this is not supported in this project
due to OWASP ASVS 15.2.5 requirement.

Javascript files *.js are checked only.

Typescript configuration that is used by VSCodium without typescript npm module:

`/tsconfig.json`

## EsLint

ESLint not supported due to OWASP ASVS 15.2.5 requirement


## JSDoc type checking and documentation

Project uses JSDoc tags for type checking and for documentation.

JSDoc comments are also used to add info to openAPI documentation to follow single source of truth pattern.

Each JSDoc comment section contains one of following tag types to be listed in a module documentation:

|{#2kv}type       	|subtype	|comment                                            |
|:--------------|:----------|:--------------------------------------------------|
|@module		|			|project uses ECMAScript modules only               |
|@namespace		|@memberof	|used to categorize functions, ex `ROUTE_REST_API`	|
|@constant		|	    	|for module constants only                          |
|@function  	|@method	|using @method on local functions only              |
|@class			|@method	|using @method on local functions only              |

Each comment section should contain supported tags types.
All tags used will be listed, however following are used:

|tag            |comments                                           |
|:--------------|---------------------------------------------------|
|@name          |                                                   |
|@description   |including class                                    |
|@param         |optional                                           |
|@example       |optional                                           |
|@returns       |except class                                       |

Type declarations are saved in separate files dedicated to type declarations only. 
Each type declaration section should contain supported tags types in a comment.
All tags used will be listed, however following are used:

|tag            |comments                                           |
|:--------------|:--------------------------------------------------|
|@typedef       |                                                   |
|@property      |optional                                           |

Type declarations are imported at module start using comment with `@import` tag.
Example
```
/&Star;&Star;
 * @import {COMMON_DOCUMENT, CommonComponentLifecycle}  from '../../../common_types.js'
 */
 ```

Refering to a type using `@type` tag. 
Example 1
```
/&Star;&Star;@type{COMMON_DOCUMENT} */
const COMMON_DOCUMENT = document;
```
Example 2
```
commonFFB({path:path, query:query, method:method, authorization_type:authorization_type, body:json})
    .then((/&Star;&Star;@type{string}*/result)=>{
        ...
    });
```
Example 3
```
/&Star;&Star;@type{import('../../../common_types.js').COMMON_DOCUMENT} */
const COMMON_DOCUMENT = document;
```

## Naming standard

|Type                   |Comment                                    |
|:----------------------|:------------------------------------------|
|snake_case             |ISO20022 REST API parameters and response keys if not from ORM, Javascript parameters, HTML element id and classes, css selectors, filenames|
|SCREAMING_SNAKE_CASE	|constants|
|PascalCase				|ORM file names, ORM object names, ORM column names, columns in ISO20022 REST API response keys from ORM|
|camelCase				|Javascript public object names|

## Test 

Behaviour Driven Development (BDD) test framework for testing Javascript code without dependencies is implemented.
Run `BDD_TEST` report in admin app and report menu to run spec files defined in `/test/specrunner.json`

**The report runs following scripts**
|Description                                |Script                                            |
|:------------------------------------------|:-------------------------------------------------|
| Specrunner with tests specified below	    |/test/specrunner.json|
| 1.Spy test           						|/apps/common/src/common.spec.js|
| 2.Unit test          						|/server/db/db.spec.js|
| 3.Integration test   						|/test/integration.spec.js|
| 4.Performance test   						|/test/performance.spec.js|


## App components

Components mounts to given div id and are rendered with similar Vue Single File Component (SFC) structure and 
can be mounted using Vue, React or pure Javascript.
Apps using React are using own developed HTML to React component conversion.
All components provided returns pure HTML and will render in both Vue and React.
Components use React iteration syntax in templates and props with placeholder expression syntax implemented with pure Javascript.
Components use Vue lifecycle pattern onMounted, onBeforeMounted and onUnmounted implemented with pure Javascript.
All React and Vue events are removed. All events created by third party code are restricted to maximum document level.
Switching framework in apps means that different framework rendered components can exist simultaneously.

## Issues
   
###	Cluster mode and Node.Js:

Native Node.js cluster functionality are not supported at the moment since closure pattern of data 
if used in the ORM database and socket connected clients and no replication method still implemented due to project following OWASP 
and consistency performance issue using replication.

###	Javascript:
Hijri transliteration on Android.

Hanidec numbers Javascript bugs:

Javascript does not support Hanidec numbers used in Chinese and North Korean numbers from 10 and above. 
For example 10 in latn number system will display the individual numbers 1 and 0 in Hanidec `一〇 (Yī and Líng)` 
and not 10 in Hanidec that should be `十 (Shí)`. 

new Intl.NumberFormat('zh-u-nu-hanidec').format(10); 
result: `一〇 (Yī and Líng)` should be `十 (Shí)`
or
`(10).toLocaleString('zh-u-nu-hanidec')`
result: `一〇 (Yī and Líng)` should be `十 (Shí)`

`(十).toLocaleString('en')` should convert hanidec to 10 in latn numbers but returns `NaN`

`String.fromCharCode(0x5341).toLocaleString('en-u-nu-latn')`
UTF-16 code unit of Hanidec `十 (Shí)`,
should return 10 in latn number but returns `十`.

Workaround for Chinese numbers in app 2:
Hijri dates and timetables date titles will use latn numbers if hanidec numbersystem is used.
Using number mapping for Chinese numbers 1-100 as workaround for timetables.

Other apps are using latn numbers.