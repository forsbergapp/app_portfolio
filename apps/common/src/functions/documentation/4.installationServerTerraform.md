# Installation server with Terrraform

[![Infrastructure as code diagram](/common/documents/iac_small.webp)](/common/documents/iac.webp)

Uses Terraform for Infrastructre as Code (IaC).
Plugins used: OCI 7.3.2 and TLS 4.2.0

|Path repository|    |
|:--------------|:---|
|$HOME/app_portfolio/server/install/terraform/main.tf|Provider and resources|
|$HOME/app_portfolio/server/install/terraform/outputs.tf|Output keys and IP|
|$HOME/app_portfolio/server/install/terraform/TEST.tfvars|Default with "TEST" in names and network 10.1.0.0/16 and subnet 10.1.0.0/24|
|$HOME/app_portfolio/server/install/terraform/PRODUCTION.tfvars|Default with "PRODUCTION" in names and network 10.2.0.0/16 and subnet 10.2.0.0/24|
|$HOME/app_portfolio/server/install/terraform/variables_environment.tf|Default same compute shape, OS, version and public IP|
|$HOME/app_portfolio/server/install/terraform/variables_providers.tf|Terraform providers and Git repository|

|Data repository|Terraform uses stateful pattern, so copy here and make modifications to avoid git changes|
|:--------------|:---|
|$HOME/data/terraform/main.tf||
|$HOME/data/terraform/outputs.tf||
|$HOME/data/terraform/TEST.tfvars||
|$HOME/data/terraform/PRODUCTION.tfvars||
|$HOME/data/terraform/variables_environment.tf||
|$HOME/data/terraform/variables_providers.tf|Provider values must be updated|

Setup terraform
```
cd $HOME/app_portfolio/data
mkdir terraform 
cp $HOME/app_portfolio/server/install/default/terraform/* terraform
//set debug if necessary
export TF_LOG=DEBUG
terraform -chdir=$HOME/app_portfolio/data/terraform init -plugin-dir=$HOME/app_portfolio/data/terraform/plugins
terraform -chdir=$HOME/app_portfolio/data/terraform workspace new TEST  
terraform -chdir=$HOME/app_portfolio/data/terraform workspace new PRODUCTION
```
Terraform commands, 
syntax to execute from any directory, reuse plugin directory and to keep track of separate environment states
```
//TEST
terraform -chdir=$HOME/app_portfolio/data/terraform workspace select TEST
terraform -chdir=$HOME/app_portfolio/data/terraform plan -var-file=TEST.tfvars
terraform -chdir=$HOME/app_portfolio/data/terraform apply -var-file=TEST.tfvars
//if old exists
rm $HOME/.ssh/TEST_private.key
//save private key and with correct file attritbutes
terraform output -raw key-private-pem>$HOME/.ssh/TEST_private.key
chmod 400 $HOME/.ssh/TEST_private.key
//connect to the new instance, update user and ip
ssh -i $HOME/.ssh/TEST_private.key [user]@[public_ip]
//destroy
terraform -chdir=$HOME/app_portfolio/data/terraform destroy 

//PRODUCTION
terraform -chdir=$HOME/app_portfolio/data/terraform workspace select PRODUCTION
terraform -chdir=$HOME/app_portfolio/data/terraform plan -var-file=PRODUCTION.tfvars
terraform -chdir=$HOME/app_portfolio/data/terraform apply -var-file=PRODUCTION.tfvars
//if old exists
rm $HOME/.ssh/PRODUCTION_private.key
//save private key and with correct file attritbutes
terraform output -raw key-private-pem>$HOME/.ssh/PRODUCTION_private.key
chmod 400 $HOME/.ssh/PRODUCTION_private.key
//connect to the new instance, update user and ip
ssh -i $HOME/.ssh/PRODUCTION_private.key [user]@[public_ip]
//destroy
terraform -chdir=$HOME/app_portfolio/data/terraform destroy 
```

monitor setup commands
```
sudo htop
sudo systemctl status app_portfolio
sudo systemctl status app_portfolio_microservice_batch
sudo cat /var/log/cloud-init-output.log
sudo cat /var/log/cloud-init.log
```

to add new environments, replace ${ENVIRONMENT} with real name
```
terraform -chdir=$HOME/app_portfolio/data/terraform workspace new ${ENVIRONMENT}
cp $HOME/app_portfolio/data/terraform/TEST.tfvars $HOME/app_portfolio/data/terraform/${ENVIRONMENT}.tfvars
//set new values
vi $HOME/app_portfolio/data/terraform/${ENVIRONMENT}.tfvars
//commands for ${ENVIRONMENT}
terraform -chdir=$HOME/app_portfolio/data/terraform workspace select ${ENVIRONMENT}
terraform -chdir=$HOME/app_portfolio/data/terraform plan -var-file=${ENVIRONMENT}.tfvars
terraform -chdir=$HOME/app_portfolio/data/terraform apply -var-file=${ENVIRONMENT}.tfvars
//if old exists
rm $HOME/.ssh/${ENVIRONMENT}_private.key
//save private key and with correct file attritbutes
terraform output -raw key-private-pem>$HOME/.ssh/${ENVIRONMENT}_private.key
chmod 400 $HOME/.ssh/${ENVIRONMENT}_private.key
//connect to the new instance, update user and ip
ssh -i $HOME/.ssh/${ENVIRONMENT}_private.key [user]@[public_ip]
//destroy
terraform -chdir=$HOME/app_portfolio/data/terraform destroy 

```

If no route to host error or other network issues:
```
sudo reboot
```