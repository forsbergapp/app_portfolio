# How to add a new app
    ECMAScript is used in project meaning package.json contains type:module.
    pm2 starts server setting current work directory to app root directory so use process.cwd() when needed.
    Import module with dynamic import() from ES2020 with this example syntax:
        import(`file://${process.cwd()}/apps/index.js`).then(function({ check_app_subdomain}){
# Required
    /apps/app[APP_ID]/scripts/		database scripts, run as database admin
                                    required (change [] values):
                                    
                                    CREATE USER app[APP_ID] ...
                                    GRANT role_app_common TO app[APP_ID];
                                    
                                    INSERT INTO app_portfolio.app
                                        (id, app_name, url, logo, enabled, app_category_id) 
                                    VALUES 
                                        ([APP_ID]],[APP_NAME],[APP_URL],[APP_LOGO_PATH], 1, [APP_CATEGORY_ID]);
                                    INSERT INTO app_portfolio.app_parameter
                                        (app_id, parameter_type_id, parameter_name, parameter_value, parameter_comment) 
                                    VALUES 
                                        ([APP_ID],'2','SERVICE_DB_APP_USER',[DB_USERNAME],NULL);
                                    INSERT INTO app_portfolio.app_parameter
                                        (app_id, parameter_type_id, parameter_name, parameter_value, parameter_comment) 
                                    VALUES 
                                        ([APP_ID],'2','SERVICE_DB_APP_PASSWORD',[DB_PASSWORD],NULL);
                    

    required files and folders
    /apps/app[APP_ID]*				contains client app files and server code
    /apps/app[APP_ID]/server.js		review /apps/[OTHER APP_ID]/server.js										
                                    minimum:
                                    const APP[APP_ID]_ID = [APP_ID];
                                    app.get('/',function (req, res, next) {
                                        import(`file://${process.cwd()}/apps/index.js`).then(function({ check_app_subdomain}){
                                            if (check_app_subdomain(APP[APP_ID]_ID, req.headers.host)){
                                                import(`file://${process.cwd()}/service/forms/forms.controller.js`).then(function({getForm}){
                                                    getForm(req, res, APP[APP_ID]_ID, null,(err, app_result)=>{
                                                                                                return res.send(app_result);
                                                                                            })
                                                })
                                            }
                                            else
                                                next();
                                        })
                                    });
                                    

    /apps/app[APP_ID]/client.js		review /apps/[OTHER APP_ID]/client.js
                                    minimum:
                                    
                                    function getApp(app_id, params, gps_lat, gps_long, gps_place){
                                        return new Promise(function (resolve, reject){
                                            const files = [
                                                ['APP', process.cwd() + '/apps/app[APP_ID]]/src/index.html']
                                            ];
                                            import(`file://${process.cwd()}/apps/index.js`).then(function({read_app_files}){
                                                read_app_files(app_id, files, (err, app)=>{
                                                    if (err)
                                                        reject(err);
                                                    else
                                                        resolve(app_init);
                                                })
                                            })
                                        })
                                    }
                                    export{getApp};

    /apps/app[APP_ID]/src			app files referred from /apps/app[APP_ID]/client.js
                                    Example with optional importing app.js into app and setting app as global.
                                    Within app global, common.js can be imported. Replace [APP_ID] with app id in use.
                                    minimum:

                                    index.html
                                        <!DOCTYPE html>
                                        <html>
                                        <head>
                                            <meta charset='UTF-8'>
                                            <title></title>
                                            <script type='text/javascript' type='module' >
                                                document.addEventListener("DOMContentLoaded", (event) =>{
                                                    import('/app[APP_ID]}/js/app.js').then(function(app){
                                                            window.app = app;
                                                            app.init(<ITEM_COMMON_PARAMETERS/>);
                                                    })
                                                });
                                            </script>
                                        </head>	
                                        <body>
                                        </body>
                                        </html>

                                    /apps/app[APP_ID]/js/app.js
                                        const common = await import('/common/js/common.js');
                                        function app_exception(){
                                            null;
                                        }
                                        function init_app(){
                                            null;
                                        }
                                        function init(parameters) {
                                            common.init_common(parameters, (err, global_app_parameters)=>{
                                                if (err)
                                                    null;
                                                else{
                                                    init_app();
                                                  }
                                            })
                                        }
                                        export{ /*EXCEPTION*/
                                                app_exception,
                                                /*INIT*/
                                                init_app, init}
    REPORTS:
    /apps/app[APP_ID]/report/index.js   review /apps/[OTHER APP_ID]/report/index.js
                                        minimum:

                                        function getReport(app_id, module, gps_lat, gps_long, gps_place){
                                            return new Promise(function (resolve, reject){
                                                const files = [
                                                    ['REPORT', process.cwd() + '/apps/app[APP_ID]/report/' + module],
                                                ];
                                                import(`file://${process.cwd()}/apps/index.js`).then(function({read_app_files}){
                                                    read_app_files(app_id, files, (err, app)=>{
                                                        if (err)
                                                            reject(err);
                                                        else
                                                            resolve(app_init);
                                                    })
                                                })
                                            })
                                        }
                                        export{getReport};

                                        /apps/app[APP_ID]/report/[REPORT_NAME].html
                                            <!DOCTYPE html>
                                            <html>
                                            <head>
                                                <script type='text/javascript' type='module' >
                                                    document.addEventListener("DOMContentLoaded", (event) =>{
                                                        import('/app[APP_ID]}/js/report.js').then(function(report){
                                                                window.report = report;
                                                                report.init(<ITEM_COMMON_PARAMETERS/>);
                                                        })
                                                    });
                                                </script>        
                                            </head>	
                                            <body>
                                                <div id='paper'></div>
                                            </body>
                                            </html>

                                        /apps/app[APP_ID]/js/report.js
                                            const common = await import('/common/js/common.js');
                                            function report_exception(){
                                                null;
                                            }
                                            function init_app_report(){
                                                document.getElementById('paper').innerHTML = 'My report';
                                            }
                                            function init(parameters) {
                                                common.init_common(parameters, (err, global_app_parameters)=>{
                                                    if (err)
                                                        null;
                                                    else{
                                                        init_app_report();
                                                    }
                                                })
                                            }
                                            export{ /*EXCEPTION*/
                                                    report_exception,
                                                    /*INIT*/
                                                    init_app_report, init}

    example call reports from client /apps/app[APP_ID]/js/app.js
        function get_report_url(id, papersize, format){
            let server_url = common.getHostname() + `${common.COMMON_GLOBAL['service_report']}`;
            let app_parameters = `app_id=${common.COMMON_GLOBAL['app_id']}`;
            let report_module = `&module=${app_common.APP_GLOBAL['app_report_timetable']}`;
            let module_parameters = `&id=${id}`
            let language_parameter = `&lang_code=${common.COMMON_GLOBAL['user_locale']}`;
            let service_parameter = `&format=${format}&ps=${papersize}&hf=0`; //html/pdf, papersize, header/footer
            let encodedurl = common.toBase64(app_parameters +
                                             report_module +
                                             module_parameters + 
                                             language_parameter +
                                             service_parameter);
            //url query parameters are decoded in report module and in report service
            return server_url + '?reportid=' + encodedurl;
        }
        app_common.APP_GLOBAL['app_report_timetable'] = '[REPORT_NAME]';
        let format = 'HTML'; //or PDF
        let url = get_report_url([id], 'A4', format);
        common.show_window_info(null, false, null, format, url);

# Optional
    client:
    /apps/app[APP_ID]/css					styles
    /apps/app[APP_ID]/images				images
    /apps/app[APP_ID]/js					javascript
    /apps/app[APP_ID]/scripts				database scripts
    /apps/app[APP_ID]/sw.js					service worker for PWA apps
    server:
    /apps/app[APP_ID]/info					info pages about disclaimer, privacy_policy, terms
    /apps/app[APP_ID]/mail					mail
    /apps/app[APP_ID]/report				reports
    /service/db/app_portfolio/app{APP_ID}*	rest api for app{APP_ID}

    common client:
    /apps/common/audio						audio
    /apps/common/css						styles
    /apps/common/images						images
    /apps/common/js							javascript
    /apps/common/modules					referred from /apps/common/src/head_[MODULE].html files
                                            use /apps/common/src/
    common server:
    /apps/common/src/						referred from /apps/app[APP_ID]/client.js
    /apps/common/report/					referred from /apps/app[APP_ID]/report

# How apps are identified
    Apps clients use common.COMMON_GLOBAL['app_id'] to identify themselves
    Common and admin uses common.COMMON_GLOBAL['common_app_id'] derived from server parameter APP_COMMON_APP_ID.

#   Restart NodeJS server to automatically load the new app.
    pm2 restart all

    Observe that apps can be enabled and disabled in table app_portfolio.app and 
    updating column enabled to 0 or 1.